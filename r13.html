<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Table Preview</title>
    <style>
        .titleImagen {
            font-size: 16px;
            padding-top: 1rem;
        }

        .generado {
            font-size: 10px;
        }

        .sgtMexRed {
            color: red;
            font-size: 12px;
        }

        .table-rep13-headers {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            font-family: Arial, sans-serif;
            text-align: center;
            /* padding-bottom: 1rem; */
        }

        .table-gral {
            border-collapse: collapse;
            border: 8px solid #616161;
            width: 100%;
            max-width: 800px;
            margin: 2px auto;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        .table-rep13 {
            border-collapse: collapse;
            border: 8px solid #616161;
            width: 100%;
            max-width: 800px;
            margin: 2px auto;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        .table-rep13-into {
            font-size: 13px;
            border: 1px solid #fff8f8;
            background-color: #b4aeae;

        }

        .tituloSeccion {
            border: 1px solid #fff8f8;
            background-color: #616161;
            color: white;
            font-size: 16px;
            font-weight: bolder;
            padding: 0.5rem;
        }

        .table-rep13-into-sbTitle {
            border: 1px solid #fff8f8;
            background-color: #616161;
            color: white;
            font-size: 16px;
            padding: 0.2rem;
        }

        .table-rep13-into-sbTitle td {
            border: 1px solid #fff8f8;
            background-color: #616161;
            color: white;
            font-size: 16px;
            padding: 0.2rem;
        }

        .table-rep13-into-sbTitle-sm td {
            border: 1px solid #fff8f8;
            background-color: #616161;
            color: white;
            font-size: 14px;
            padding: 0.1rem;
        }

        .table-rep13-into-commit td {
            font-size: 12px;
            border: 1px solid white;
            background-color: #fff8f8;
            height: 150px;
        }

        .table-rep13-mn-light {
            font-size: 12px;
            border: 1px solid white;
            background-color: #b4aeae;
        }

        .table-rep13-mn-dark {
            font-size: 12px;
            border: 1px solid white;
            background-color: #fff8f8;
        }

        .one-line {
            display: flex;
        }

        .table-rep13-border td {
            background-color: #878787;

        }

        .table-rep13 tr:nth-child(odd) {
            background-color: #b4aeae;
            border: 1px solid #616161;
        }

        .table-rep13 tr:nth-child(even) {
            background-color: #fff8f8;
            border: 1px solid #616161;
        }

        .table-rep13 td:nth-child(odd) {
            border: 1px solid white;
        }

        .table-rep13 td:nth-child(even) {
            border: 1px solid white;
        }

        .onTime {
            display: inline-block;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background-color: greenyellow;
        }

        .outTime {
            display: inline-block;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background-color: red;
        }

        .timer-line {
            height: 30px;
        }

        .img-pais {
            height: 50px;
            width: 60px;
            border-radius: 50%;
        }

        .img-empresa {
            height: 50px;
            width: 60px;
        }
    </style>
</head>

<body>
    <div id="controls">
        <input type="file" id="excelFile" accept=".xlsx, .xls" />
        <!-- <input type="text" id="rangeInput" placeholder="Ejemplo: A1:D10" /> -->
        <button id="previewTable">Previsualizar Tabla</button>
        <button id="generateImage" style="display: none;">Generar Imagen</button>
    </div>
    <div id="tableContainer">
        <table id="styledTable-title" class="table-rep13-headers">
            <tbody>
                <tr>
                    <td rowspan="3"><img class="img-pais" src="../assets/img/Flag_of_Mexico.svg.png" alt="pais"></td>
                    <td class="titleImagen" colspan="3">SEGUIMIENTO A SUCURSALES</td>
                    <td rowspan="3"><img class="img-empresa" src="../assets/img/flama.jpg" alt="santander"></td>
                </tr>
                <tr>
                    <td id="fecha" class="generado" colspan="3">08:00 HRS - Tuesday 21 de January</td>
                </tr>
                <tr>
                    <td class="sgtMexRed" colspan="3">SGT México</td>
                </tr>
                <tr>
                    <td colspan="5"></td>
                </tr>
            </tbody>
        </table>

        <table id="styledTable-comunicaciones" class="table-gral">
            <thead>
                <tr class="table-rep13-into" id="data-comunicaciones">
                    <td colspan="5" class="tituloSeccion">COMUNICACIONES</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="table-rep13-into-sbTitle" rowspan="2" style="width: 120px;">Total de oficinas:</td>
                    <td class="table-rep13-mn-light" colspan="2" style="width: 100px;">Total Off:</td>
                    <td class="table-rep13-mn-light" style="width: 150px;">Servidor</td>
                    <td class="table-rep13-mn-light data-typeInc" id="servidor">0</td>
                </tr>
                <tr>
                    <td class="table-rep13-mn-dark" style="font-size: 16px;" colspan="2" rowspan="2" id="suc-off">0
                    </td>
                    <td class="table-rep13-mn-dark">Comunicaciones</td>
                    <td class="table-rep13-mn-dark data-typeInc" id="comunicaciones">0</td>
                </tr>
                <tr>
                    <td id="suc-total" class="table-rep13-into-sbTitle" rowspan="3">1,323</td>
                    <td class="table-rep13-mn-light">Energía E.</td>
                    <td class="table-rep13-mn-light data-typeInc" id="energia">0</td>
                </tr>
                <tr>
                    <td class="table-rep13-mn-light" colspan="2">Contingencia:</td>
                    <td class="table-rep13-mn-dark">Backup</td>
                    <td class="table-rep13-mn-dark data-typeInc" id="backup">0</td>
                </tr>
                <tr>
                    <td class="table-rep13-mn-dark" style="font-size: 16px;" colspan="2" id="contingencia">0</td>
                    <td class="table-rep13-mn-light">Lentitud</td>
                    <td class="table-rep13-mn-light data-typeInc" id="lentitud">0</td>
                </tr>
            </tbody>
        </table>
        <table id="styledTable-comunicaciones" class="table-rep13">
            <thead>
                <tr class="table-rep13-into">
                    <td class="table-rep13-into-sbTitle" colspan="5">Carriers con problemas</td>
                </tr>
            </thead>
            <tbody id="data-carriers" class="table-rep13-into"></tbody>
        </table>
        <table class="table-gral">
            <thead>
                <tr class="table-rep13-into">
                    <td colspan="5" class="tituloSeccion">INCIDENTES SERVICENOW Service Desk y WhatsApp</td>
                </tr>
                <tr class="table-rep13-into-sbTitle">
                    <td rowspan="2">Región</td>
                    <td colspan="2">Software</td>
                    <td colspan="2">Hardware</td>
                </tr>
                <tr class="table-rep13-into-sbTitle-sm timer-line">
                    <td>En Tiempo <span class="onTime"></span></td>
                    <td>Vencidos <span class="outTime"></span></td>
                    <td>En Tiempo <span class="onTime"></span></td>
                    <td>Vencidos <span class="outTime"></span></td>
                </tr>
            </thead>
            <tbody id="incidentes-sh-content" class="table-rep13 table-rep13-into">
                <tr>
                    <td data-v="Centro">Centro</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Metro Norte">Metro Norte</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Metro Sur">Metro Sur</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Norte">Norte</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Noreste">Noreste</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Noroeste">Noroeste</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Occidente">Occidente</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Sur">Sur</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Sureste">Sureste</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr class="table-rep13-into-sbTitle">
                    <td data-v="Total">Total</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td colspan="5"></td>
                </tr>
            </tbody>
        </table>
        <table class="table-gral">
            <thead>
                <tr class="table-rep13-into-sbTitle">
                    <td rowspan="2">Región</td>
                    <td colspan="2">Comunicaciones</td>
                    <td colspan="2">Multifuncionales</td>
                </tr>
                <tr class="table-rep13-into-sbTitle-sm">
                    <td>En Tiempo <span class="onTime"></span></td>
                    <td>Vencidos <span class="outTime"></span></td>
                    <td>En Tiempo <span class="onTime"></span></td>
                    <td>Vencidos <span class="outTime"></span></td>
                </tr>
            </thead>
            <tbody id="incidentes-cm-content" class="table-rep13 table-rep13-into">
                <tr>
                    <td data-v="Centro">Centro</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Metro Norte">Metro Norte</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Metro Sur">Metro Sur</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Norte">Norte</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Noreste">Noreste</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Noroeste">Noroeste</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Occidente">Occidente</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Sur">Sur</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td data-v="Sureste">Sureste</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr class="table-rep13-into-sbTitle">
                    <td data-v="Total">Total</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td colspan="5"></td>
                </tr>
            </tbody>
        </table>
        <table id="detail-sf" class="table-rep13">
            <thead>
                <tr class="table-rep13-into-sbTitle">
                    <td colspan="5" data-v="Comentarios">Comentarios</td>
                </tr>
            </thead>
            <tbody id="data-commits" class="table-rep13-into-commit">
                <tr>
                    <td colspan="5" id="sucFuera">1124-KIOSCO TUIIO ACAYUCAN
                        0418-ROSARITO
                        0168-TAMPICO</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="imageContainer" style="text-align: center;"></div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>
    <script>
        function formatDateTime(language) {
            const date = new Date();

            // Obtener componentes de la fecha y hora
            const hours = date.getHours();
            const minutes = date.getMinutes(); // No es necesario, pero puedes usarlo si quieres añadirlos
            const day = date.getDate();

            const daysEnglish = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const daysSpanish = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];

            const monthsEnglish = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const monthsSpanish = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            // Elegir días y meses según el idioma
            const days = language === "es" ? daysSpanish : daysEnglish;
            const months = language === "es" ? monthsSpanish : monthsEnglish;

            // Formatear la fecha y hora
            const dayName = days[date.getDay()];
            const monthName = months[date.getMonth()];

            // Construir la cadena final
            const dateTimeString =
                `${hours.toString().padStart(2, '0')}:00 HRS - ${dayName} ${day} ${language === "es" ? "de" : ""} ${monthName}`;

            return dateTimeString;
        }

        const showFecha = document.getElementById('fecha')
        showFecha.innerHTML = ''
        showFecha.innerHTML = formatDateTime("en")

        document.getElementById('previewTable').addEventListener('click', () => {
            const input = document.getElementById('excelFile');
            const rangeInput = 'A1:G49';
            const rangeCarrierOut = 'B13:F18';
            // const rangeInput = document.getElementById('rangeInput').value.trim();
            if (!input.files.length || !rangeInput) {
                alert('Selecciona un archivo Excel y especifica un rango.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Lee la primera hoja del archivo Excel
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];

                // Convierte el rango seleccionado a HTML
                const range = XLSX.utils.decode_range(rangeCarrierOut);
                const filteredSheet = filterEmptyCells(sheet, range);
                const htmlTable = XLSX.utils.sheet_to_html(filteredSheet);
                const divCarrier = document.createElement('div')
                divCarrier.innerHTML = htmlTable;
                const tbodyCarrierNew = divCarrier.querySelector('tbody')
                const tbodyCarrier = document.getElementById('data-carriers')
                tbodyCarrier.innerHTML = ''
                tbodyCarrier.innerHTML = tbodyCarrierNew.innerHTML
                const trCarrier = tbodyCarrier.querySelectorAll('tr')

                const jsonDataTypeInc = XLSX.utils.sheet_to_json(sheet, {
                    range: "E7:F11",
                    header: ['type', 'valor']
                })
                const cellsIncType = document.querySelectorAll('.data-typeInc')
                for (const [i, cellIncType] of cellsIncType.entries()) {
                    cellsIncType[i].innerHTML = ''
                    cellsIncType[i].innerHTML = jsonDataTypeInc[i].valor
                }

                const cellContingencia = document.getElementById('contingencia')
                cellContingencia.innerHTML = ''
                const totalLentitud = jsonDataTypeInc[jsonDataTypeInc.length - 1].valor
                const totalBackup = jsonDataTypeInc[jsonDataTypeInc.length - 2].valor
                cellContingencia.innerHTML = (totalLentitud + totalBackup);

                const jsonDataCommits = XLSX.utils.sheet_to_json(sheet, {
                    range: "B48:F48",
                    header: ['valor']
                })

                const jsonSucFuera = jsonDataCommits[0].valor.trim().split('\r\n')
                const sucOff = document.getElementById('suc-off')
                const sucOffCommit = document.getElementById('sucFuera')
                sucOff.innerHTML = jsonSucFuera.length
                sucOffCommit.innerHTML = `${jsonSucFuera.join('; ')}`

                // // Inserta la tabla con estilos
                // const container = document.getElementById('tableContainer');
                // container.innerHTML = htmlTable;

                // const table = container.querySelector('table');
                // table.id = 'styledTable';

                // Muestra el botón para generar imagen
                document.getElementById('generateImage').style.display = 'inline-block';
            };

            reader.readAsArrayBuffer(input.files[0]);
        });

        document.getElementById('generateImage').addEventListener('click', () => {
            const container = document.getElementById('tableContainer');
            if (!container.innerHTML) {
                alert('No hay tabla para convertir a imagen.');
                return;
            }

            // Convierte la tabla en imagen
            // html2canvas(container).then((canvas) => {
            //     const link = document.createElement('a');
            //     link.href = canvas.toDataURL('image/png', 1.0);
            //     link.download = `table_preview.png`;
            //     link.click();

            //     // Muestra la imagen generada
            //     document.getElementById('imageContainer').innerHTML = '';
            //     container.style.display = 'none';
            //     document.getElementById('imageContainer').appendChild(canvas);
            // });

                        // Convierte la tabla en imagen
            html2canvas64(container).then((canvas) => {
                // Genera el enlace de descarga
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png', 1.0); // Genera imagen en formato base64
                link.download = `table_preview.png`;
                link.click();
            
                // Obtén la imagen en base64
                const base64Image = canvas.toDataURL('image/png', 1.0);
                console.log('Imagen en Base64:', base64Image);
            
                // Muestra la imagen generada
                document.getElementById('imageContainer').innerHTML = '';
                container.style.display = 'none';
                document.getElementById('imageContainer').appendChild(canvas);
            
                // Si necesitas usar la imagen en base64, puedes almacenarla o enviarla a un servidor
                // sendImageToServer(base64Image);
            });
            
            // Ejemplo de una función para enviar la imagen en base64 al servidor
            function sendImageToServer(base64Image) {
                fetch('/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: base64Image }),
                })
                .then(response => response.json())
                .then(data => console.log('Imagen enviada con éxito:', data))
                .catch(error => console.error('Error al enviar la imagen:', error));
            }

        });

        // Función para filtrar filas/columnas vacías
        function filterEmptyCells(sheet, range) {
            const newSheet = {};
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    if (sheet[cellAddress] && sheet[cellAddress].v !== undefined) {
                        newSheet[cellAddress] = sheet[cellAddress];
                    }
                }
            }
            newSheet['!ref'] = XLSX.utils.encode_range(range);
            return newSheet;
        }
    </script>
</body>

</html>
