CREATE DEFINER=`u170798671_rangeldiaz`@`%` PROCEDURE `userLogg`(usr VARCHAR(18))
BEGIN
/*Procedimiento usado en API*/
DECLARE u VARCHAR(8);
DECLARE var_id INT;
DECLARE edo INT;
DECLARE life INT;

SET u = (SELECT `user` FROM coboradores_catalogo WHERE `user` = usr AND estatus = 1);
call TokenDrop();
/*DELETE FROM idtokens WHERE (ididtokens >= 1) AND (usuario = u) AND catovatechDate() >= expira;*/

SET var_id = (SELECT idcoboradore FROM coboradores_catalogo WHERE user = usr AND estatus = 1);
SET edo = (SELECT COUNT(idu) FROM idtokens WHERE idu = var_id);
SET life = (SELECT TIMESTAMPDIFF(MINUTE, catovatechDate(), expira) FROM idtokens WHERE idu = var_id);

IF edo >= 1 THEN 
	SELECT CONCAT('Hay una sesion activa debe esperar ', life, ' min. para volver a acceder al sistema') code_msg, '403' AS 'code', 'warning' as 'typeAlert';
ELSE
	IF u = usr THEN
		SELECT idcoboradore as 'id', 'pass' AS code_msg, '202' AS 'code', 'success' as 'typeAlert', pass as 'Password' FROM coboradores_catalogo where user = u;		
	ELSE
		SELECT 'Las Credenciales son invalidas' code_msg, '403' AS 'code', 'danger' as 'typeAlert';
	END IF;
END IF;

END
